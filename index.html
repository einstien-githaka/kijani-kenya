<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Kijani Kenya â€” Urban Green Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0b1f13;--surface:#122b1a;--surface2:#1a3d26;
  --border:rgba(80,200,120,0.12);--moss:#4db87a;--sage:#8fd4a8;
  --lime:#c8f5d8;--sun:#f7a940;--coral:#f06b4d;--sky:#5bc4e8;
  --text:#e8f7ee;--muted:rgba(232,247,238,0.5);--danger:#e05252;--warn:#f7a940;
}
html{scroll-behavior:smooth}
body{font-family:'Crimson Pro',serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
.app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
.sidebar{background:linear-gradient(180deg,#0d2418 0%,#091910 100%);border-right:1px solid var(--border);padding:1.75rem 1.25rem;position:sticky;top:0;height:100vh;overflow-y:auto;display:flex;flex-direction:column}
.logo{display:flex;align-items:center;gap:.75rem;margin-bottom:2.5rem;text-decoration:none}
.logo-icon{width:38px;height:38px;background:var(--moss);border-radius:.6rem;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
.logo-text{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;color:var(--text);line-height:1.1}
.logo-text span{color:var(--moss);display:block;font-size:.7rem;font-weight:400;letter-spacing:.12em;text-transform:uppercase}
.nav-section{font-size:.65rem;text-transform:uppercase;letter-spacing:.15em;color:var(--muted);margin:1.5rem 0 .5rem .5rem}
.nav-link{display:flex;align-items:center;gap:.75rem;padding:.6rem .75rem;border-radius:.5rem;color:rgba(232,247,238,.65);text-decoration:none;font-family:'Syne',sans-serif;font-size:.82rem;font-weight:600;letter-spacing:.02em;transition:all .18s;cursor:pointer;border:none;background:none;width:100%;text-align:left;margin-bottom:2px}
.nav-link:hover{background:rgba(77,184,122,.1);color:var(--moss)}
.nav-link.active{background:rgba(77,184,122,.15);color:var(--moss);border-left:3px solid var(--moss)}
.nav-link .icon{font-size:1rem;width:20px;text-align:center}
.nav-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:.65rem;font-family:'Syne',sans-serif;padding:.1rem .4rem;border-radius:.75rem;min-width:18px;text-align:center}
.sidebar-footer{margin-top:auto;padding-top:1.5rem;border-top:1px solid var(--border)}
.user-pill{display:flex;align-items:center;gap:.75rem;padding:.75rem;background:var(--surface);border-radius:.6rem}
.user-avatar{width:34px;height:34px;border-radius:50%;background:var(--moss);color:var(--bg);font-family:'Syne',sans-serif;font-weight:800;font-size:.85rem;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.user-info{min-width:0}
.user-name{font-family:'Syne',sans-serif;font-size:.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-role{font-size:.72rem;color:var(--moss);text-transform:uppercase;letter-spacing:.08em}
.main{display:flex;flex-direction:column;min-height:100vh}
.topbar{background:rgba(11,31,19,.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.page-title{font-family:'Syne',sans-serif;font-size:1.25rem;font-weight:800}
.topbar-right{display:flex;align-items:center;gap:1rem}
.btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem 1.25rem;border-radius:.45rem;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;letter-spacing:.04em;border:none;cursor:pointer;transition:all .18s;text-decoration:none}
.btn-primary{background:var(--moss);color:var(--bg)}
.btn-primary:hover{background:#3da668;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--moss);color:var(--moss)}
.btn-sm{padding:.35rem .85rem;font-size:.75rem}
.content{padding:2rem;flex:1}
.page{display:none}.page.active{display:block}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2rem}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:.85rem;padding:1.4rem 1.25rem;position:relative;overflow:hidden;transition:border-color .2s}
.stat-card:hover{border-color:rgba(77,184,122,.3)}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--moss);opacity:0;transition:opacity .2s}
.stat-card:hover::after{opacity:1}
.stat-value{font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;line-height:1;margin-bottom:.25rem}
.stat-label{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;font-family:'Syne',sans-serif}
.stat-sub{font-size:.82rem;color:var(--sage);margin-top:.4rem}
.stat-icon{position:absolute;top:1rem;right:1.25rem;font-size:1.8rem;opacity:.25}
.stat-card.danger{border-color:rgba(224,82,82,.2)}.stat-card.danger::after{background:var(--danger);opacity:1}
.card{background:var(--surface);border:1px solid var(--border);border-radius:.85rem;margin-bottom:1.5rem;overflow:hidden}
.card-header{padding:1.25rem 1.5rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.card-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:.75rem 1.5rem;font-family:'Syne',sans-serif;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);border-bottom:1px solid var(--border)}
td{padding:.85rem 1.5rem;font-size:.9rem;border-bottom:1px solid rgba(80,200,120,0.06);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(77,184,122,.04)}
.progress-wrap{display:flex;align-items:center;gap:.75rem}
.progress-bar{flex:1;height:6px;background:rgba(77,184,122,.1);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--moss),var(--sage));transition:width .6s ease}
.progress-fill.warn{background:linear-gradient(90deg,var(--warn),#ffc85a)}
.progress-fill.danger{background:linear-gradient(90deg,var(--coral),#f08060)}
.progress-pct{font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--sage);min-width:38px;text-align:right}
.badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .65rem;border-radius:1rem;font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase}
.badge-active{background:rgba(77,184,122,.15);color:var(--moss);border:1px solid rgba(77,184,122,.25)}
.badge-planning{background:rgba(91,196,232,.12);color:var(--sky);border:1px solid rgba(91,196,232,.2)}
.badge-complete{background:rgba(232,247,238,.08);color:var(--lime);border:1px solid rgba(232,247,238,.15)}
.badge-warn{background:rgba(247,169,64,.12);color:var(--warn);border:1px solid rgba(247,169,64,.25)}
.badge-danger{background:rgba(224,82,82,.12);color:var(--danger);border:1px solid rgba(224,82,82,.25)}
.alerts-list{display:flex;flex-direction:column;gap:.75rem;padding:1.25rem 1.5rem}
.alert-item{display:flex;gap:1rem;padding:1rem 1.25rem;border-radius:.65rem;align-items:flex-start}
.alert-item.warning{background:rgba(247,169,64,.08);border:1px solid rgba(247,169,64,.2)}
.alert-item.danger{background:rgba(224,82,82,.08);border:1px solid rgba(224,82,82,.2)}
.alert-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:.3rem}
.alert-item.warning .alert-dot{background:var(--warn)}
.alert-item.danger .alert-dot{background:var(--danger)}
.alert-msg{font-size:.9rem;line-height:1.5;flex:1}
.alert-meta{font-size:.78rem;color:var(--muted);margin-top:.3rem;font-family:'Syne',sans-serif}
.county-chart{display:flex;flex-direction:column;gap:.6rem;padding:1.25rem 1.5rem}
.county-row{display:flex;align-items:center;gap:1rem}
.county-name{font-family:'Syne',sans-serif;font-size:.78rem;font-weight:600;width:120px;flex-shrink:0}
.county-bar-wrap{flex:1;height:22px;background:rgba(77,184,122,.08);border-radius:.25rem;overflow:hidden}
.county-bar{height:100%;background:linear-gradient(90deg,var(--moss),var(--sage));border-radius:.25rem;display:flex;align-items:center;padding-left:.5rem;transition:width .8s ease}
.county-count{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--sage);min-width:60px;text-align:right}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.form-group{display:flex;flex-direction:column;gap:.4rem}
.form-group.full{grid-column:1/-1}
label{font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
input,select,textarea{background:var(--bg);border:1px solid var(--border);border-radius:.45rem;padding:.65rem .9rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:.95rem;outline:none;transition:border-color .18s;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--moss);box-shadow:0 0 0 3px rgba(77,184,122,.1)}
select option{background:var(--bg)}
textarea{resize:vertical;min-height:80px}
.form-actions{display:flex;gap:.75rem;justify-content:flex-end;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:2rem}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:1rem;width:100%;max-width:620px;max-height:90vh;overflow-y:auto}
.modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800}
.modal-close{background:none;border:none;color:var(--muted);font-size:1.4rem;cursor:pointer;line-height:1;transition:color .18s}
.modal-close:hover{color:var(--text)}
.modal-body{padding:1.5rem}
#login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:500;background:radial-gradient(ellipse at 30% 50%,rgba(77,184,122,.08) 0%,transparent 60%),var(--bg)}
.login-card{width:420px;background:var(--surface);border:1px solid var(--border);border-radius:1.25rem;padding:2.5rem;animation:fadeUp .4s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.login-logo{text-align:center;margin-bottom:2rem}
.login-logo .icon{font-size:2.5rem;display:block;margin-bottom:.75rem}
.login-logo h1{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800}
.login-logo p{color:var(--muted);font-size:.95rem;margin-top:.3rem}
.login-footer{margin-top:1.25rem;text-align:center;font-size:.8rem;color:var(--muted);line-height:1.6}
.login-footer code{background:var(--bg);padding:.1rem .4rem;border-radius:.25rem;font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--sage)}
.error-msg{background:rgba(224,82,82,.1);border:1px solid rgba(224,82,82,.25);color:var(--danger);padding:.75rem 1rem;border-radius:.45rem;font-size:.88rem;margin-bottom:1rem;display:none}
.success-msg{background:rgba(77,184,122,.1);border:1px solid rgba(77,184,122,.25);color:var(--moss);padding:.75rem 1rem;border-radius:.45rem;font-size:.88rem;margin-bottom:1rem;display:none}
.site-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem}
.detail-block{background:var(--surface2);border-radius:.65rem;padding:1.1rem}
.detail-label{font-family:'Syne',sans-serif;font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:.4rem}
.detail-value{font-size:1.05rem;font-weight:600}
.big-number{font-family:'Syne',sans-serif;font-size:2.2rem;font-weight:800;color:var(--moss)}
.report-card{background:var(--surface2);border-radius:.65rem;padding:1.2rem;margin-bottom:.75rem;border-left:3px solid var(--moss)}
.report-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem}
.report-site{font-family:'Syne',sans-serif;font-size:.85rem;font-weight:700}
.report-date{font-size:.78rem;color:var(--muted);font-family:'Syne',sans-serif}
.report-stats{display:flex;gap:1.5rem;margin:.5rem 0}
.report-stat{font-size:.82rem}
.report-stat span{color:var(--moss);font-weight:600;font-family:'Syne',sans-serif}
.report-challenge{font-size:.85rem;color:var(--muted);font-style:italic;margin-top:.4rem}
.empty{text-align:center;padding:3rem;color:var(--muted)}
.empty-icon{font-size:3rem;margin-bottom:1rem;opacity:.5}
.empty-text{font-size:1rem}
.filter-bar{display:flex;gap:.75rem;margin-bottom:1.5rem;flex-wrap:wrap}
.filter-select{background:var(--surface);border:1px solid var(--border);border-radius:.45rem;padding:.5rem .85rem;color:var(--text);font-family:'Syne',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;outline:none}
.filter-select:focus{border-color:var(--moss)}
.search-input{background:var(--surface);border:1px solid var(--border);border-radius:.45rem;padding:.5rem 1rem;color:var(--text);font-family:'Crimson Pro',serif;font-size:.9rem;outline:none;min-width:220px}
.search-input:focus{border-color:var(--moss)}
#toast{position:fixed;bottom:2rem;right:2rem;background:var(--surface);border:1px solid var(--border);border-radius:.65rem;padding:1rem 1.25rem;font-family:'Syne',sans-serif;font-size:.85rem;font-weight:600;z-index:999;transform:translateY(100px);opacity:0;transition:all .3s;max-width:340px}
#toast.show{transform:translateY(0);opacity:1}
#toast.success{border-color:var(--moss);color:var(--moss)}
#toast.error{border-color:var(--danger);color:var(--danger)}
.fade-in{animation:fadeIn .35s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
@media(max-width:900px){.app{grid-template-columns:1fr}.sidebar{display:none}.stats-grid{grid-template-columns:repeat(2,1fr)}.site-detail-grid{grid-column:1fr}.form-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo"><span class="icon">ğŸŒ³</span><h1>Kijani Kenya</h1><p>Urban Green Progress Tracker</p></div>
    <div style="display:flex;gap:.5rem;margin-bottom:1.5rem;border-bottom:1px solid var(--border);padding-bottom:.75rem">
      <button id="tab-signin" onclick="switchTab('signin')" style="flex:1;padding:.5rem;border:none;background:var(--moss);color:var(--bg);border-radius:.4rem;font-family:'Syne',sans-serif;font-weight:700;font-size:.82rem;cursor:pointer">Sign In</button>
      <button id="tab-register" onclick="switchTab('register')" style="flex:1;padding:.5rem;border:1px solid var(--border);background:transparent;color:var(--muted);border-radius:.4rem;font-family:'Syne',sans-serif;font-weight:700;font-size:.82rem;cursor:pointer">Register</button>
    </div>
    <div id="panel-signin">
      <div id="login-error" class="error-msg"></div>
      <div class="form-group" style="margin-bottom:1rem"><label>Email Address</label><input type="email" id="login-email" placeholder="you@gmail.com"/></div>
      <div class="form-group" style="margin-bottom:1.5rem"><label>Password</label>
        <div style="position:relative">
          <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="padding-right:3rem"/>
          <button onclick="togglePassword()" type="button" style="position:absolute;right:.75rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:.85rem" id="toggle-pw-btn">ğŸ‘</button>
        </div>
      </div>
      <button class="btn btn-primary" style="width:100%;justify-content:center;padding:.8rem" onclick="doLogin()">Sign In â†’</button>
    </div>
    <div id="panel-register" style="display:none">
      <div id="reg-error" class="error-msg"></div>
      <div id="reg-success" class="success-msg" style="display:none;background:rgba(77,184,122,.15);border:1px solid var(--moss);color:var(--moss);padding:.75rem 1rem;border-radius:.5rem;margin-bottom:1rem;font-size:.88rem"></div>
      <div class="form-group" style="margin-bottom:.75rem"><label>Full Name *</label><input type="text" id="reg-name" placeholder="e.g. Wanjiru Njoki"/></div>
      <div class="form-group" style="margin-bottom:.75rem"><label>Email Address *</label><input type="email" id="reg-email" placeholder="you@gmail.com"/></div>
      <div class="form-group" style="margin-bottom:.75rem"><label>Password * (min 6 chars)</label>
        <div style="position:relative">
          <input type="password" id="reg-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="padding-right:3rem"/>
          <button onclick="toggleRegPassword()" type="button" style="position:absolute;right:.75rem;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:.85rem" id="toggle-reg-btn">ğŸ‘</button>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:.75rem"><label>Role *</label>
        <select id="reg-role"><option value="officer">Field Officer</option><option value="ngo">NGO Partner</option></select>
      </div>
      <div class="form-group" style="margin-bottom:1.25rem"><label>County</label>
        <select id="reg-county">
          <option value="">â€” Select County â€”</option>
          <option>Nairobi</option><option>Mombasa</option><option>Kisumu</option><option>Nakuru</option>
          <option>Uasin Gishu</option><option>Kiambu</option><option>Machakos</option><option>Meru</option>
          <option>Nyeri</option><option>Muranga</option><option>Kilifi</option><option>Kwale</option>
          <option>Kajiado</option><option>Laikipia</option><option>Nandi</option><option>Kericho</option>
          <option>Bomet</option><option>Narok</option><option>Trans-Nzoia</option><option>Baringo</option>
          <option>Samburu</option><option>Turkana</option><option>Marsabit</option><option>Isiolo</option>
          <option>Garissa</option><option>Wajir</option><option>Mandera</option><option>Lamu</option>
          <option>Taita-Taveta</option><option>Siaya</option><option>Homa Bay</option><option>Migori</option>
          <option>Kisii</option><option>Nyamira</option><option>Vihiga</option><option>Kakamega</option>
          <option>Bungoma</option><option>Busia</option><option>Embu</option><option>Kitui</option>
        </select>
      </div>
      <button class="btn btn-primary" style="width:100%;justify-content:center;padding:.8rem" onclick="doRegister()">Request Access â†’</button>
      <div style="margin-top:.75rem;font-size:.78rem;color:var(--muted);text-align:center">Your account will be reviewed by an admin before you can log in.</div>
    </div>
    <div class="login-footer" style="margin-top:1rem;text-align:center">
      <button onclick="showPublicDashboard()" style="background:none;border:none;color:var(--moss);cursor:pointer;font-size:.82rem;font-family:'Syne',sans-serif;text-decoration:underline">ğŸŒ View Public Dashboard (no login)</button>
    </div>
  </div>
</div>

<!-- PUBLIC DASHBOARD -->
<div id="public-screen" style="display:none;min-height:100vh;background:var(--bg);padding:2rem">
  <div style="max-width:960px;margin:0 auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem">
      <div><h1 style="font-family:'Syne',sans-serif;font-size:1.8rem;font-weight:800">ğŸŒ¿ Kijani Kenya</h1><div style="color:var(--muted)">Live Urban Green Progress</div></div>
      <button class="btn btn-outline btn-sm" onclick="hidePublicDashboard()">â† Sign In</button>
    </div>
    <div id="public-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:2rem"></div>
    <h3 style="font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;margin-bottom:1rem;color:var(--sage)">PLANTING SITES</h3>
    <div id="public-sites" style="display:grid;gap:1rem"></div>
  </div>
</div>

<!-- APP SHELL -->
<div class="app" id="app-shell" style="display:none">
  <aside class="sidebar">
    <a class="logo" href="#">
      <div class="logo-icon">ğŸŒ¿</div>
      <div class="logo-text">Kijani Kenya<span>Green Tracker</span></div>
    </a>
    <span class="nav-section">Overview</span>
    <button class="nav-link active" data-page="dashboard" onclick="navigate('dashboard')"><span class="icon">ğŸ“Š</span> Dashboard</button>
    <button class="nav-link" data-page="alerts" onclick="navigate('alerts')"><span class="icon">ğŸ””</span> Alerts <span class="nav-badge" id="alert-badge" style="display:none">0</span></button>
    <span class="nav-section">Planting Sites</span>
    <button class="nav-link" data-page="sites" onclick="navigate('sites')"><span class="icon">ğŸ—ºï¸</span> All Sites</button>
    <button class="nav-link" data-page="add-site" onclick="navigate('add-site')" id="nav-add-site"><span class="icon">â•</span> Add Site</button>
    <span class="nav-section">Field Work</span>
    <button class="nav-link" data-page="reports" onclick="navigate('reports')"><span class="icon">ğŸ“‹</span> Field Reports</button>
    <button class="nav-link" data-page="submit-report" onclick="navigate('submit-report')" id="nav-submit-report"><span class="icon">ğŸ“</span> Submit Report</button>
    <span class="nav-section">Management</span>
    <button class="nav-link" data-page="users" onclick="navigate('users')" id="nav-users"><span class="icon">ğŸ‘¥</span> Users</button>
    <button class="nav-link" data-page="docs" onclick="navigate('docs')"><span class="icon">ğŸ“–</span> API Docs</button>
    <div class="sidebar-footer">
      <div class="user-pill">
        <div class="user-avatar" id="sidebar-avatar">--</div>
        <div class="user-info">
          <div class="user-name" id="sidebar-name">Loading...</div>
          <div class="user-role" id="sidebar-role">â€”</div>
        </div>
      </div>
      <button class="btn btn-outline btn-sm" style="width:100%;margin-top:.75rem;justify-content:center" onclick="logout()">Sign Out</button>
      <button class="btn btn-outline btn-sm" style="width:100%;margin-top:.4rem;justify-content:center;border-color:var(--danger);color:var(--danger)" onclick="openDeleteAccount()">ğŸ—‘ Delete My Account</button>
    </div>
  </aside>

  <div class="main">
    <header class="topbar">
      <h1 class="page-title" id="topbar-title">Dashboard</h1>
      <div class="topbar-right">
        <button class="btn btn-outline btn-sm" onclick="navigate('docs')">ğŸ“– API Docs</button>
        <button class="btn btn-primary btn-sm" id="topbar-action" onclick="navigate('submit-report')">+ Submit Report</button>
      </div>
    </header>

    <div class="content">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div class="stats-grid">
          <div class="stat-card fade-in"><div class="stat-icon">ğŸ—ºï¸</div><div class="stat-value" id="s-sites">â€”</div><div class="stat-label">Total Sites</div><div class="stat-sub" id="s-active">â€” active</div></div>
          <div class="stat-card fade-in"><div class="stat-icon">ğŸŒ³</div><div class="stat-value" id="s-planted">â€”</div><div class="stat-label">Trees Planted</div><div class="stat-sub" id="s-progress">â€” of target</div></div>
          <div class="stat-card fade-in"><div class="stat-icon">ğŸ’š</div><div class="stat-value" id="s-survival">â€”%</div><div class="stat-label">Survival Rate</div><div class="stat-sub" id="s-surviving">â€” surviving</div></div>
          <div class="stat-card fade-in" id="s-alert-card"><div class="stat-icon">ğŸ””</div><div class="stat-value" id="s-alerts">â€”</div><div class="stat-label">Open Alerts</div><div class="stat-sub">Requires attention</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1.6fr 1fr;gap:1.5rem">
          <div class="card fade-in">
            <div class="card-header"><span class="card-title">ğŸ—ºï¸ Planting Sites Overview</span><button class="btn btn-outline btn-sm" onclick="navigate('sites')">View All</button></div>
            <table><thead><tr><th>Site</th><th>Progress</th><th>Survival</th><th>Status</th></tr></thead>
            <tbody id="dashboard-sites-tbody"><tr><td colspan="4" style="text-align:center;color:var(--muted);padding:2rem">Loading...</td></tr></tbody></table>
          </div>
          <div style="display:flex;flex-direction:column;gap:1.5rem">
            <div class="card fade-in">
              <div class="card-header"><span class="card-title">ğŸ“ Trees by County</span></div>
              <div class="county-chart" id="county-chart"><div style="color:var(--muted);font-size:.9rem;text-align:center;padding:1rem">Loading...</div></div>
            </div>
            <div class="card fade-in">
              <div class="card-header"><span class="card-title">ğŸ”” Active Alerts</span><span class="badge badge-danger" id="alert-count-badge">0</span></div>
              <div id="dashboard-alerts-list" style="padding:.75rem 1.5rem 1.25rem"><div style="color:var(--muted);font-size:.9rem">Loading...</div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SITES -->
      <div class="page" id="page-sites">
        <div class="filter-bar">
          <input type="text" class="search-input" placeholder="ğŸ” Search sites..." id="sites-search" oninput="renderSitesPage()"/>
          <select class="filter-select" id="sites-status-filter" onchange="renderSitesPage()">
            <option value="">All Statuses</option><option value="active">Active</option><option value="planning">Planning</option><option value="complete">Complete</option>
          </select>
          <select class="filter-select" id="sites-county-filter" onchange="renderSitesPage()">
            <option value="">All Counties</option><option>Nairobi</option><option>Mombasa</option><option>Kisumu</option><option>Nakuru</option><option>Uasin Gishu</option>
          </select>
          <select class="filter-select" id="sites-alert-filter" onchange="renderSitesPage()">
            <option value="">All Sites</option><option value="alert">âš ï¸ With Alerts Only</option>
          </select>
        </div>
        <div class="card">
          <table><thead><tr><th>Site Name</th><th>County</th><th>Type</th><th>Progress</th><th>Survival</th><th>Last Update</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="sites-tbody"><tr><td colspan="8" style="text-align:center;color:var(--muted);padding:2rem">Loading...</td></tr></tbody></table>
        </div>
      </div>

      <!-- SITE DETAIL -->
      <div class="page" id="page-site-detail">
        <button class="btn btn-outline btn-sm" style="margin-bottom:1.5rem" onclick="navigate('sites')">â† Back to Sites</button>
        <div id="site-detail-content"></div>
      </div>

      <!-- ADD SITE -->
      <div class="page" id="page-add-site">
        <div class="card">
          <div class="card-header"><span class="card-title">â• Register New Planting Site</span></div>
          <div class="modal-body">
            <div id="add-site-msg" class="success-msg"></div>
            <div id="add-site-err" class="error-msg"></div>
            <div class="form-grid">
              <div class="form-group full"><label>Site Name *</label><input type="text" id="ns-name" placeholder="e.g. Uhuru Park Extension"/></div>
              <div class="form-group"><label>County *</label>
                <select id="ns-county"><option value="">Select county</option><option>Nairobi</option><option>Mombasa</option><option>Kisumu</option><option>Nakuru</option><option>Uasin Gishu</option><option>Machakos</option><option>Kiambu</option></select>
              </div>
              <div class="form-group"><label>Sub-County</label><input type="text" id="ns-sub" placeholder="e.g. Westlands"/></div>
              <div class="form-group"><label>Site Type *</label>
                <select id="ns-type"><option value="">Select type</option><option value="forest_corridor">Forest Corridor</option><option value="urban_park">Urban Park</option><option value="road_corridor">Road Corridor</option><option value="wetland_mangrove">Wetland / Mangrove</option><option value="school_greening">School Greening</option><option value="community_garden">Community Garden</option></select>
              </div>
              <div class="form-group"><label>Target Trees *</label><input type="number" id="ns-target" placeholder="e.g. 2000" min="1"/></div>
              <div class="form-group"><label>Area (hectares)</label><input type="number" id="ns-area" placeholder="e.g. 5.5" step="0.1"/></div>
              <div class="form-group"><label>Latitude *</label><input type="number" id="ns-lat" placeholder="-1.2921" step="any"/></div>
              <div class="form-group"><label>Longitude *</label><input type="number" id="ns-lng" placeholder="36.8219" step="any"/></div>
              <div class="form-group"><label>Start Date *</label><input type="date" id="ns-start"/></div>
              <div class="form-group"><label>Target Completion Date</label><input type="date" id="ns-end"/></div>
              <div class="form-group full"><label>Species (comma-separated)</label><input type="text" id="ns-species" placeholder="e.g. Croton megalocarpus, African Olive"/></div>
              <div class="form-group full"><label>Notes</label><textarea id="ns-notes" placeholder="Any relevant notes..."></textarea></div>
              <div class="form-group full">
                <label>ğŸ“¸ Site Photos</label>
                <button type="button" class="btn btn-outline" onclick="uploadPhotos('site')" style="margin-bottom:.75rem">ğŸ“· Upload Photos</button>
                <div id="site-photo-previews" style="display:flex;flex-wrap:wrap;gap:.5rem"></div>
                <input type="hidden" id="site-photos-data" value="[]"/>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-outline" onclick="navigate('sites')">Cancel</button>
              <button class="btn btn-primary" onclick="submitNewSite()">Register Site â†’</button>
            </div>
          </div>
        </div>
      </div>

      <!-- REPORTS -->
      <div class="page" id="page-reports">
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ“‹ Field Reports</span><button class="btn btn-primary btn-sm" onclick="navigate('submit-report')">+ Submit Report</button></div>
          <div id="reports-list" style="padding:1.25rem 1.5rem"><div style="color:var(--muted)">Loading...</div></div>
        </div>
      </div>

      <!-- SUBMIT REPORT -->
      <div class="page" id="page-submit-report">
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ“ Submit Field Report</span></div>
          <div class="modal-body">
            <div id="report-msg" class="success-msg"></div>
            <div id="report-err" class="error-msg"></div>
            <div class="form-grid">
              <div class="form-group full"><label>Planting Site *</label><select id="rpt-site"></select></div>
              <div class="form-group"><label>Trees Planted Today *</label><input type="number" id="rpt-planted" placeholder="e.g. 150" min="0"/></div>
              <div class="form-group"><label>Trees That Died</label><input type="number" id="rpt-died" placeholder="e.g. 12" min="0" value="0"/></div>
              <div class="form-group"><label>Weather Conditions</label><input type="text" id="rpt-weather" placeholder="e.g. Sunny, 28Â°C"/></div>
              <div class="form-group"><label>Soil Condition</label><input type="text" id="rpt-soil" placeholder="e.g. Good, moist"/></div>
              <div class="form-group full"><label>Challenges Encountered</label><textarea id="rpt-challenges" placeholder="Any obstacles or observations..."></textarea></div>
              <div class="form-group full">
                <label>ğŸ“¸ Upload Photos</label>
                <button type="button" class="btn btn-outline" onclick="uploadPhotos('rpt')" style="margin-bottom:.75rem">ğŸ“· Choose Photos</button>
                <div id="rpt-photo-previews" style="display:flex;flex-wrap:wrap;gap:.5rem"></div>
                <input type="hidden" id="rpt-photos-data" value="[]"/>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-outline" onclick="navigate('reports')">Cancel</button>
              <button class="btn btn-primary" onclick="submitReport()">Submit Report â†’</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ALERTS -->
      <div class="page" id="page-alerts">
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ”” Active Alerts</span><span class="badge badge-danger" id="alerts-page-count">0</span></div>
          <div class="alerts-list" id="alerts-list-full"><div style="color:var(--muted)">Loading...</div></div>
        </div>
      </div>

      <!-- USERS -->
      <div class="page" id="page-users">
        <div id="pending-section" class="card" style="display:none;margin-bottom:1.5rem;border-color:rgba(247,169,64,.3)">
          <div class="card-header" style="background:rgba(247,169,64,.08)">
            <span class="card-title" style="color:var(--warn)">â³ Pending Approvals</span>
            <span id="pending-count" style="background:var(--warn);color:var(--bg);border-radius:.5rem;padding:.1rem .6rem;font-size:.75rem;font-family:'Syne',sans-serif;font-weight:700">0</span>
          </div>
          <div id="pending-list" style="padding:1rem;display:grid;gap:.75rem"></div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">ğŸ‘¥ Team Members</span><button class="btn btn-primary btn-sm" onclick="openAddUser()">+ Add User</button></div>
          <table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>County</th><th>Joined</th><th>Actions</th></tr></thead>
          <tbody id="users-tbody"><tr><td colspan="5" style="text-align:center;color:var(--muted);padding:2rem">Loading...</td></tr></tbody></table>
        </div>
      </div>

      <!-- DOCS -->
      <div class="page" id="page-docs">
        <div style="max-width:860px">
          <div class="card fade-in" style="margin-bottom:1.5rem">
            <div class="card-header"><span class="card-title">ğŸ“– Kijani Kenya â€” API Reference</span></div>
            <div class="modal-body">
              <p style="color:var(--muted);line-height:1.7;margin-bottom:1rem">The Kijani Kenya API solves the problem of <strong style="color:var(--text)">fragmented, manual urban tree planting tracking</strong> across Kenya's counties.</p>
              <div style="background:var(--bg);border:1px solid var(--border);border-radius:.5rem;padding:1rem;font-family:'JetBrains Mono',monospace;font-size:.82rem;color:var(--moss)">Base URL: https://kijani-kenya-production.up.railway.app/api</div>
            </div>
          </div>
          <div class="card fade-in" style="margin-bottom:1rem">
            <div class="card-header" style="cursor:pointer" onclick="toggleSection('auth-body')"><span class="card-title">ğŸ” Authentication</span><span style="color:var(--muted)">â–¼</span></div>
            <div id="auth-body" class="modal-body">
              <pre style="background:var(--bg);border:1px solid var(--border);border-radius:.45rem;padding:1rem;font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--lime);overflow-x:auto">POST /api/auth/login
{ "email": "<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d8bdabacb0bdaa98bfb5b9b1b4f6bbb7b5">[email&#160;protected]</a>", "password": "Admin2026!" }
â†’ { "token": "eyJ...", "user": { "role": "admin" } }

GET /api/auth/me   (requires Authorization: Bearer token)</pre>
            </div>
          </div>
          <div class="card fade-in" style="margin-bottom:1rem">
            <div class="card-header" style="cursor:pointer" onclick="toggleSection('sites-body')"><span class="card-title">ğŸ—ºï¸ Sites &amp; Reports</span><span style="color:var(--muted)">â–¼</span></div>
            <div id="sites-body" class="modal-body">
              <table style="font-size:.85rem"><thead><tr><th>Method</th><th>Endpoint</th><th>Auth</th><th>Description</th></tr></thead>
              <tbody>
                <tr><td><span class="badge badge-active">GET</span></td><td><code>/api/sites</code></td><td>Any</td><td>List all sites</td></tr>
                <tr><td><span class="badge badge-active">GET</span></td><td><code>/api/sites/:id</code></td><td>Any</td><td>Site detail with reports</td></tr>
                <tr><td><span class="badge badge-warn">POST</span></td><td><code>/api/sites</code></td><td>Officer+</td><td>Register new site</td></tr>
                <tr><td><span class="badge badge-planning">PATCH</span></td><td><code>/api/sites/:id/progress</code></td><td>Officer+</td><td>Update planted count</td></tr>
                <tr><td><span class="badge badge-active">GET</span></td><td><code>/api/reports</code></td><td>Login</td><td>All field reports</td></tr>
                <tr><td><span class="badge badge-warn">POST</span></td><td><code>/api/reports</code></td><td>Officer+</td><td>Submit field report</td></tr>
                <tr><td><span class="badge badge-active">GET</span></td><td><code>/api/alerts</code></td><td>Login</td><td>Open alerts</td></tr>
                <tr><td><span class="badge badge-active">GET</span></td><td><code>/api/stats</code></td><td>None</td><td>Public dashboard stats</td></tr>
                <tr><td><span class="badge badge-active">GET</span></td><td><code>/api/health</code></td><td>None</td><td>Server health check</td></tr>
              </tbody></table>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- ADD USER MODAL -->
<div class="modal-overlay" id="add-user-modal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">â• Add Team Member</span><button class="modal-close" onclick="closeAddUser()">âœ•</button></div>
    <div class="modal-body">
      <div id="add-user-err" class="error-msg"></div>
      <div class="form-grid">
        <div class="form-group"><label>Full Name *</label><input type="text" id="nu-name" placeholder="e.g. Wanjiru Njoki"/></div>
        <div class="form-group"><label>Email *</label><input type="email" id="nu-email" placeholder="wanjiru@gmail.com"/></div>
        <div class="form-group"><label>Password *</label><input type="password" id="nu-password" placeholder="Min 8 chars"/></div>
        <div class="form-group"><label>Role *</label>
          <select id="nu-role"><option value="officer">Field Officer</option><option value="ngo">NGO Partner</option><option value="public">Public Viewer</option><option value="admin">Admin</option></select>
        </div>
        <div class="form-group full"><label>County</label><input type="text" id="nu-county" placeholder="e.g. Nairobi"/></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeAddUser()">Cancel</button>
        <button class="btn btn-primary" onclick="submitAddUser()">Create User â†’</button>
      </div>
    </div>
  </div>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div class="modal-overlay" id="change-pw-modal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">ğŸ”‘ Change Password</span><button class="modal-close" onclick="closeChangePassword()">âœ•</button></div>
    <div class="modal-body">
      <div id="change-pw-err" class="error-msg"></div>
      <div id="change-pw-success" class="success-msg"></div>
      <p style="color:var(--muted);font-size:.88rem;margin-bottom:1.25rem">Changing password for: <strong id="change-pw-name" style="color:var(--text)"></strong></p>
      <div id="change-pw-current-wrap" class="form-group" style="margin-bottom:1rem">
        <label>Current Password</label>
        <input type="password" id="change-pw-current" placeholder="Enter current password"/>
      </div>
      <div class="form-group" style="margin-bottom:1rem">
        <label>New Password *</label>
        <input type="password" id="change-pw-new" placeholder="Min 6 characters"/>
      </div>
      <div class="form-group" style="margin-bottom:1.5rem">
        <label>Confirm New Password *</label>
        <input type="password" id="change-pw-confirm" placeholder="Repeat new password"/>
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeChangePassword()">Cancel</button>
        <button class="btn btn-primary" onclick="submitChangePassword()">Update Password â†’</button>
      </div>
    </div>
  </div>
</div>

<!-- DELETE ACCOUNT MODAL -->
<div class="modal-overlay" id="delete-account-modal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title" style="color:var(--danger)">ğŸ—‘ Delete My Account</span><button class="modal-close" onclick="closeDeleteAccount()">âœ•</button></div>
    <div class="modal-body">
      <div id="delete-account-err" class="error-msg"></div>
      <div style="background:rgba(224,82,82,.08);border:1px solid rgba(224,82,82,.2);border-radius:.5rem;padding:1rem;margin-bottom:1.25rem">
        <p style="color:var(--danger);font-size:.9rem;font-weight:600">âš ï¸ This action is permanent and cannot be undone.</p>
        <p style="color:var(--muted);font-size:.85rem;margin-top:.4rem">Your account, profile and access will be permanently removed.</p>
      </div>
      <div class="form-group" style="margin-bottom:1.5rem">
        <label>Enter your password to confirm</label>
        <input type="password" id="delete-account-pw" placeholder="Your current password"/>
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="closeDeleteAccount()">Cancel</button>
        <button class="btn btn-primary" style="background:var(--danger)" onclick="submitDeleteAccount()">Yes, Delete My Account</button>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var API = 'https://kijani-kenya-production.up.railway.app/api';
var state = { token:null, user:null, stats:null, sites:[], reports:[], alerts:[], users:[], currentPage:'dashboard' };

// â”€â”€ CLOUDINARY CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var CLOUDINARY_CLOUD  = 'dfk0aqvf0';
var CLOUDINARY_PRESET = 'kijani_uploads';
var CLOUDINARY_URL    = 'https://api.cloudinary.com/v1_1/' + CLOUDINARY_CLOUD + '/image/upload';

// â”€â”€ PHOTO UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function uploadPhotos(context) {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.multiple = true;
  input.onchange = function() {
    var files = Array.prototype.slice.call(input.files);
    var previewId = context === 'rpt' ? 'rpt-photo-previews' : 'site-photo-previews';
    var dataId    = context === 'rpt' ? 'rpt-photos-data'    : 'site-photos-data';
    var existing  = JSON.parse(document.getElementById(dataId).value || '[]');
    var pending   = files.length;
    if (pending === 0) return;
    toast('Uploading ' + pending + ' photo(s)...', 'info');
    files.forEach(function(file) {
      var fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', CLOUDINARY_PRESET);
      fetch(CLOUDINARY_URL, { method: 'POST', body: fd })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.secure_url) {
            existing.push(data.secure_url);
            document.getElementById(dataId).value = JSON.stringify(existing);
            var prev = document.getElementById(previewId);
            var img = document.createElement('div');
            img.style.cssText = 'position:relative;width:80px;height:80px;border-radius:.4rem;overflow:hidden;border:1px solid var(--border)';
            img.innerHTML = '<img src="' + data.secure_url + '" style="width:100%;height:100%;object-fit:cover"/>';
            prev.appendChild(img);
            pending--;
            if (pending === 0) toast('Photos uploaded!', 'success');
          }
        })
        .catch(function() { toast('Photo upload failed', 'error'); });
    });
  };
  input.click();
}

// â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  var signin   = document.getElementById('panel-signin');
  var register = document.getElementById('panel-register');
  var tabSign  = document.getElementById('tab-signin');
  var tabReg   = document.getElementById('tab-register');
  if (tab === 'signin') {
    signin.style.display   = 'block';
    register.style.display = 'none';
    tabSign.style.background = 'var(--moss)';
    tabSign.style.color      = 'var(--bg)';
    tabSign.style.border     = 'none';
    tabReg.style.background  = 'transparent';
    tabReg.style.color       = 'var(--muted)';
    tabReg.style.border      = '1px solid var(--border)';
  } else {
    signin.style.display   = 'none';
    register.style.display = 'block';
    tabReg.style.background  = 'var(--moss)';
    tabReg.style.color       = 'var(--bg)';
    tabReg.style.border      = 'none';
    tabSign.style.background = 'transparent';
    tabSign.style.color      = 'var(--muted)';
    tabSign.style.border     = '1px solid var(--border)';
  }
}

// â”€â”€ TOGGLE PASSWORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePassword() {
  var input = document.getElementById('login-password');
  var btn   = document.getElementById('toggle-pw-btn');
  if (input.type === 'password') { input.type = 'text';     btn.textContent = 'ğŸ™ˆ'; }
  else                           { input.type = 'password'; btn.textContent = 'ğŸ‘'; }
}
function toggleRegPassword() {
  var input = document.getElementById('reg-password');
  var btn   = document.getElementById('toggle-reg-btn');
  if (input.type === 'password') { input.type = 'text';     btn.textContent = 'ğŸ™ˆ'; }
  else                           { input.type = 'password'; btn.textContent = 'ğŸ‘'; }
}

// â”€â”€ REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doRegister() {
  var errEl = document.getElementById('reg-error');
  var sucEl = document.getElementById('reg-success');
  errEl.style.display = sucEl.style.display = 'none';

  var body = {
    name:     document.getElementById('reg-name').value.trim(),
    email:    document.getElementById('reg-email').value.trim(),
    password: document.getElementById('reg-password').value,
    role:     document.getElementById('reg-role').value,
    county:   document.getElementById('reg-county').value || null,
  };

  if (!body.name || !body.email || !body.password) {
    errEl.textContent = 'Please fill in name, email and password';
    errEl.style.display = 'block';
    return;
  }

  fetch(API + '/auth/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  })
  .then(function(res) { return res.json().then(function(d) { return { ok: res.ok, data: d }; }); })
  .then(function(r) {
    if (!r.ok) { errEl.textContent = r.data.error; errEl.style.display = 'block'; return; }
    sucEl.textContent = 'âœ… ' + r.data.message;
    sucEl.style.display = 'block';
    document.getElementById('reg-name').value = '';
    document.getElementById('reg-email').value = '';
    document.getElementById('reg-password').value = '';
  })
  .catch(function() { errEl.textContent = 'Cannot connect to server.'; errEl.style.display = 'block'; });
}

// â”€â”€ PUBLIC DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPublicDashboard() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('public-screen').style.display = 'block';
  fetch(API + '/stats')
    .then(function(r) { return r.json(); })
    .then(function(stats) {
      var s = stats.summary;
      var statsEl = document.getElementById('public-stats');
      statsEl.innerHTML =
        pubStat('ğŸ—ºï¸', s.total_sites, 'Total Sites', s.active_sites + ' active') +
        pubStat('ğŸŒ³', (s.total_planted || 0).toLocaleString(), 'Trees Planted', s.overall_progress + '% of target') +
        pubStat('ğŸ’š', s.overall_survival + '%', 'Survival Rate', s.total_surviving.toLocaleString() + ' surviving') +
        pubStat('ğŸ“', s.counties_covered, 'Counties', s.total_area_ha + ' ha total');
    });
  fetch(API + '/sites')
    .then(function(r) { return r.json(); })
    .then(function(res) {
      var sites = res.data || [];
      var el = document.getElementById('public-sites');
      el.innerHTML = sites.map(function(s) {
        return '<div style="background:var(--surface);border:1px solid var(--border);border-radius:.85rem;padding:1.25rem">' +
          '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem;flex-wrap:wrap;gap:.5rem">' +
          '<div><div style="font-family:\'Syne\',sans-serif;font-weight:700;font-size:1rem">' + s.name + '</div>' +
          '<div style="font-size:.8rem;color:var(--muted)">ğŸ“ ' + s.county + ' Â· ' + typeName(s.type) + '</div></div>' +
          statusBadge(s.status, s.alert) + '</div>' +
          '<div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem">' +
          '<div><div style="font-size:.75rem;color:var(--muted);margin-bottom:.3rem">PROGRESS</div>' +
          '<div style="background:rgba(255,255,255,.05);border-radius:.3rem;height:8px"><div style="background:var(--moss);height:100%;border-radius:.3rem;width:' + Math.min(s.progress_pct,100) + '%"></div></div>' +
          '<div style="font-size:.78rem;color:var(--sage);margin-top:.3rem">' + s.planted.toLocaleString() + ' / ' + s.target_trees.toLocaleString() + ' (' + s.progress_pct + '%)</div></div>' +
          '<div><div style="font-size:.75rem;color:var(--muted);margin-bottom:.3rem">SURVIVAL</div>' +
          '<div style="font-size:1.1rem;font-weight:700;color:' + (s.survival_rate < 85 ? 'var(--danger)' : 'var(--moss)') + '">' + s.survival_rate + '%</div>' +
          '<div style="font-size:.78rem;color:var(--muted)">' + s.surviving.toLocaleString() + ' trees</div></div></div>' +
          (s.notes ? '<div style="font-size:.82rem;color:var(--muted);border-top:1px solid var(--border);padding-top:.75rem">' + s.notes + '</div>' : '') + '</div>';
      }).join('');
    });
}

function pubStat(icon, val, label, sub) {
  return '<div style="background:var(--surface);border:1px solid var(--border);border-radius:.85rem;padding:1.25rem">' +
    '<div style="font-size:1.5rem;margin-bottom:.4rem">' + icon + '</div>' +
    '<div style="font-family:\'Syne\',sans-serif;font-size:1.4rem;font-weight:800;color:var(--moss)">' + val + '</div>' +
    '<div style="font-size:.8rem;color:var(--text);margin-bottom:.2rem">' + label + '</div>' +
    '<div style="font-size:.75rem;color:var(--muted)">' + sub + '</div></div>';
}

function hidePublicDashboard() {
  document.getElementById('public-screen').style.display = 'none';
  document.getElementById('login-screen').style.display  = 'flex';
}

// â”€â”€ PENDING USERS (Admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadPending() {
  if (!state.user || state.user.role !== 'admin') return;
  apiCall('/users/pending').then(function(r) {
    var pending = r.data.data || [];
    var section = document.getElementById('pending-section');
    var list    = document.getElementById('pending-list');
    var count   = document.getElementById('pending-count');
    if (pending.length === 0) {
      section.style.display = 'none';
      return;
    }
    section.style.display = 'block';
    count.textContent = pending.length;
    list.innerHTML = pending.map(function(u) {
      return '<div style="display:flex;align-items:center;justify-content:space-between;background:var(--bg);border:1px solid var(--border);border-radius:.5rem;padding:.75rem 1rem;flex-wrap:wrap;gap:.75rem">' +
        '<div>' +
        '<div style="font-family:\'Syne\',sans-serif;font-weight:700;font-size:.9rem">' + u.name + '</div>' +
        '<div style="font-size:.8rem;color:var(--muted)">' + u.email + ' Â· ' + u.role + ' Â· ' + (u.county || 'No county') + '</div>' +
        '<div style="font-size:.75rem;color:var(--muted)">Requested: ' + (u.requested_at ? new Date(u.requested_at).toLocaleDateString() : u.joined) + '</div>' +
        '</div>' +
        '<div style="display:flex;gap:.5rem">' +
        '<button class="btn btn-primary btn-sm" onclick="approveUser(\'' + u.id + '\')">âœ… Approve</button>' +
        '<button class="btn btn-outline btn-sm" style="border-color:var(--danger);color:var(--danger)" onclick="rejectUser(\'' + u.id + '\')">âœ• Reject</button>' +
        '</div></div>';
    }).join('');
  });
}

function approveUser(id) {
  apiCall('/users/pending/' + id + '/approve', 'POST').then(function(r) {
    if (r.res.ok) {
      toast('User approved!', 'success');
      loadPending();
      loadUsers().then(function() { renderUsersPage(); });
    } else {
      toast(r.data.error || 'Error', 'error');
    }
  });
}

function rejectUser(id) {
  if (!confirm('Reject this registration request?')) return;
  apiCall('/users/pending/' + id, 'DELETE').then(function(r) {
    if (r.res.ok) { toast('Request rejected', 'success'); loadPending(); }
  });
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
  var email    = document.getElementById('login-email').value.trim();
  var password = document.getElementById('login-password').value;
  var errEl    = document.getElementById('login-error');
  errEl.style.display = 'none';

  fetch(API + '/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: email, password: password })
  })
  .then(function(res) {
    return res.json().then(function(data) { return { ok: res.ok, data: data }; });
  })
  .then(function(result) {
    if (!result.ok) {
      errEl.textContent = result.data.error || 'Login failed';
      errEl.style.display = 'block';
      return;
    }
    state.token = result.data.token;
    state.user  = result.data.user;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-shell').style.display    = 'grid';
    setupUserUI();
    loadAll();
  })
  .catch(function() {
    errEl.textContent = 'Cannot connect to server. Make sure the backend is running on port 3000.';
    errEl.style.display = 'block';
  });
}

function logout() {
  state = { token:null, user:null, stats:null, sites:[], reports:[], alerts:[], users:[], currentPage:'dashboard' };
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app-shell').style.display    = 'none';
}

document.addEventListener('keydown', function(e) {
  var ls = document.getElementById('login-screen');
  if (e.key === 'Enter' && ls.style.display !== 'none') doLogin();
});

// â”€â”€ SETUP UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupUserUI() {
  var u = state.user;
  document.getElementById('sidebar-avatar').textContent = u.avatar || u.name.slice(0,2).toUpperCase();
  document.getElementById('sidebar-name').textContent   = u.name;
  document.getElementById('sidebar-role').textContent   = u.role;

  var isOfficer = u.role === 'officer' || u.role === 'ngo' || u.role === 'admin';
  var isAdmin   = u.role === 'admin';

  document.getElementById('nav-add-site').style.display      = isOfficer ? 'flex' : 'none';
  document.getElementById('nav-submit-report').style.display = isOfficer ? 'flex' : 'none';
  document.getElementById('nav-users').style.display         = isAdmin   ? 'flex' : 'none';
  document.getElementById('topbar-action').style.display     = isOfficer ? 'inline-flex' : 'none';
}

// â”€â”€ API HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function apiCall(path, method, body) {
  method = method || 'GET';
  var opts = { method: method, headers: { 'Content-Type': 'application/json' } };
  if (state.token) opts.headers['Authorization'] = 'Bearer ' + state.token;
  if (body) opts.body = JSON.stringify(body);
  return fetch(API + path, opts).then(function(res) {
    return res.json().then(function(data) { return { res: res, data: data }; });
  });
}

// â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadAll() {
  var promises = [loadStats(), loadSites(), loadAlerts(), loadReports()];
  if (state.user.role === 'admin') promises.push(loadUsers());
  Promise.all(promises).then(function() {
    renderDashboard();
    if (state.user.role === 'admin') loadPending();
  });
}

function loadStats()   { return apiCall('/stats').then(function(r)   { state.stats   = r.data; }); }
function loadSites()   { return apiCall('/sites').then(function(r)   { state.sites   = r.data.data || []; }); }
function loadAlerts()  { return apiCall('/alerts').then(function(r)  { state.alerts  = r.data.data || []; }); }
function loadReports() { return apiCall('/reports').then(function(r) { state.reports = r.data.data || []; }); }
function loadUsers()   { return apiCall('/users').then(function(r)   { state.users   = r.data.data || []; }); }

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var pageTitles = { dashboard:'Dashboard', sites:'Planting Sites', 'site-detail':'Site Detail', 'add-site':'Register Site', reports:'Field Reports', 'submit-report':'Submit Report', alerts:'Active Alerts', users:'Team Members', docs:'API Documentation' };

function navigate(page) {
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.nav-link').forEach(function(l) { l.classList.remove('active'); });
  var pageEl = document.getElementById('page-' + page);
  if (pageEl) pageEl.classList.add('active');
  var navEl = document.querySelector('[data-page="' + page + '"]');
  if (navEl) navEl.classList.add('active');
  document.getElementById('topbar-title').textContent = pageTitles[page] || page;
  state.currentPage = page;
  if (page === 'sites')          renderSitesPage();
  if (page === 'reports')        renderReportsPage();
  if (page === 'alerts')         renderAlertsPage();
  if (page === 'users')          { loadUsers().then(function() { renderUsersPage(); loadPending(); }); }
  if (page === 'submit-report')  populateSiteSelect();
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard() {
  var s = state.stats && state.stats.summary;
  if (!s) return;

  document.getElementById('s-sites').textContent    = s.total_sites;
  document.getElementById('s-active').textContent   = s.active_sites + ' active Â· ' + s.complete_sites + ' complete';
  document.getElementById('s-planted').textContent  = s.total_planted.toLocaleString();
  document.getElementById('s-progress').textContent = s.overall_progress + '% of ' + s.total_target.toLocaleString() + ' target';
  document.getElementById('s-survival').textContent = s.overall_survival + '%';
  document.getElementById('s-surviving').textContent= (s.total_surviving || 0).toLocaleString() + ' surviving';
  document.getElementById('s-alerts').textContent   = s.open_alerts;

  var alertCard = document.getElementById('s-alert-card');
  alertCard.className = 'stat-card fade-in' + (s.open_alerts > 0 ? ' danger' : '');

  var badge = document.getElementById('alert-badge');
  badge.textContent    = s.open_alerts;
  badge.style.display  = s.open_alerts > 0 ? 'inline' : 'none';
  document.getElementById('alert-count-badge').textContent = state.alerts.length;

  // Sites table
  var tbody = document.getElementById('dashboard-sites-tbody');
  tbody.innerHTML = state.sites.slice(0,6).map(function(site) {
    return '<tr style="cursor:pointer" onclick="viewSite(\'' + site.id + '\')">' +
      '<td><div style="font-family:\'Syne\',sans-serif;font-size:.85rem;font-weight:700">' + site.name + '</div><div style="font-size:.78rem;color:var(--muted)">' + site.county + '</div></td>' +
      '<td style="min-width:160px"><div class="progress-wrap"><div class="progress-bar"><div class="progress-fill ' + (site.progress_pct < 50 ? 'warn' : '') + '" style="width:' + Math.min(site.progress_pct,100) + '%"></div></div><span class="progress-pct">' + site.progress_pct + '%</span></div></td>' +
      '<td><span style="font-family:\'JetBrains Mono\',monospace;font-size:.82rem;color:' + (site.survival_rate < 85 ? 'var(--danger)' : 'var(--moss)') + '">' + site.survival_rate + '%</span></td>' +
      '<td>' + statusBadge(site.status, site.alert) + '</td></tr>';
  }).join('');

  // County chart
  var byCounty = state.stats.by_county || [];
  var maxPlanted = 1;
  byCounty.forEach(function(c) { if (c.planted > maxPlanted) maxPlanted = c.planted; });
  document.getElementById('county-chart').innerHTML = byCounty.map(function(c) {
    var w = Math.max((c.planted / maxPlanted) * 100, 4);
    return '<div class="county-row"><span class="county-name">' + c.county + '</span><div class="county-bar-wrap"><div class="county-bar" style="width:' + w + '%"><span style="font-size:.65rem;color:var(--bg);font-family:\'Syne\',sans-serif;font-weight:700">' + (c.planted > 200 ? c.planted.toLocaleString() : '') + '</span></div></div><span class="county-count">' + c.planted.toLocaleString() + ' ğŸŒ³</span></div>';
  }).join('');

  // Alerts
  var alertsEl = document.getElementById('dashboard-alerts-list');
  if (state.alerts.length === 0) {
    alertsEl.innerHTML = '<div style="color:var(--moss);font-size:.9rem">âœ… No active alerts</div>';
  } else {
    alertsEl.innerHTML = state.alerts.slice(0,3).map(function(a) {
      return '<div style="padding:.6rem 0;border-bottom:1px solid var(--border)"><div style="font-size:.82rem;font-family:\'Syne\',sans-serif;font-weight:700;color:' + (a.severity === 'danger' ? 'var(--danger)' : 'var(--warn)') + '">âš ï¸ ' + (a.site_name || a.site_id) + '</div><div style="font-size:.82rem;color:var(--muted);margin-top:.2rem">' + a.message + '</div></div>';
    }).join('');
  }
}

// â”€â”€ SITES PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSitesPage() {
  var searchEl  = document.getElementById('sites-search');
  var statusEl  = document.getElementById('sites-status-filter');
  var countyEl  = document.getElementById('sites-county-filter');
  var alertFEl  = document.getElementById('sites-alert-filter');
  var search    = searchEl  ? searchEl.value.toLowerCase()  : '';
  var status    = statusEl  ? statusEl.value                : '';
  var county    = countyEl  ? countyEl.value                : '';
  var alertF    = alertFEl  ? alertFEl.value                : '';

  var sites = state.sites.slice();
  if (search)  sites = sites.filter(function(s) { return s.name.toLowerCase().indexOf(search) > -1 || s.county.toLowerCase().indexOf(search) > -1; });
  if (status)  sites = sites.filter(function(s) { return s.status === status; });
  if (county)  sites = sites.filter(function(s) { return s.county === county; });
  if (alertF)  sites = sites.filter(function(s) { return s.alert !== null; });

  var tbody = document.getElementById('sites-tbody');
  if (sites.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8"><div class="empty"><div class="empty-icon">ğŸŒ±</div><div class="empty-text">No sites found</div></div></td></tr>';
    return;
  }
  tbody.innerHTML = sites.map(function(site) {
    return '<tr><td><div style="font-family:\'Syne\',sans-serif;font-weight:700;font-size:.88rem">' + site.name + '</div><div style="font-size:.75rem;color:var(--muted)">' + typeName(site.type) + '</div></td>' +
      '<td>' + site.county + '</td><td style="font-size:.78rem;color:var(--muted)">' + typeName(site.type) + '</td>' +
      '<td style="min-width:160px"><div class="progress-wrap"><div class="progress-bar"><div class="progress-fill ' + (site.progress_pct < 40 ? 'danger' : site.progress_pct < 70 ? 'warn' : '') + '" style="width:' + Math.min(site.progress_pct,100) + '%"></div></div><span class="progress-pct">' + site.progress_pct + '%</span></div><div style="font-size:.72rem;color:var(--muted);margin-top:.2rem">' + site.planted.toLocaleString() + ' / ' + site.target_trees.toLocaleString() + '</div></td>' +
      '<td><span style="font-family:\'JetBrains Mono\',monospace;font-size:.85rem;font-weight:600;color:' + (site.survival_rate < 85 ? 'var(--danger)' : site.survival_rate < 90 ? 'var(--warn)' : 'var(--moss)') + '">' + site.survival_rate + '%</span></td>' +
      '<td style="font-size:.82rem;color:var(--muted)">' + site.last_updated + '</td>' +
      '<td>' + statusBadge(site.status, site.alert) + '</td>' +
      '<td><button class="btn btn-outline btn-sm" onclick="viewSite(\'' + site.id + '\')">View</button></td></tr>';
  }).join('');
}

function viewSite(id) {
  var site = null;
  state.sites.forEach(function(s) { if (s.id === id) site = s; });
  if (!site) return;
  var canEdit = ['admin','officer','ngo'].indexOf(state.user && state.user.role) > -1;
  var html = '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">' +
    '<div><h2 style="font-family:\'Syne\',sans-serif;font-size:1.6rem;font-weight:800;margin-bottom:.25rem">' + site.name + '</h2>' +
    '<div style="color:var(--muted);font-size:.9rem">ğŸ“ ' + (site.sub_county ? site.sub_county + ', ' : '') + site.county + ' Â· ' + typeName(site.type) + '</div></div>' +
    '<div style="display:flex;gap:.75rem;align-items:center">' + statusBadge(site.status, site.alert) +
    (canEdit ? '<button class="btn btn-primary btn-sm" onclick="navigate(\'submit-report\');document.getElementById(\'rpt-site\').value=\'' + id + '\'">+ Report</button>' : '') + '</div></div>';

  if (site.alert) {
    html += '<div class="alert-item ' + (site.alert === 'survival_rate_low' ? 'danger' : 'warning') + '" style="margin-bottom:1.5rem"><div class="alert-dot"></div><div class="alert-msg">âš ï¸ Alert: ' + alertTypeName(site.alert) + '</div></div>';
  }

  html += '<div class="site-detail-grid">' +
    '<div class="detail-block"><div class="detail-label">Trees Planted</div><div class="big-number">' + site.planted.toLocaleString() + '</div><div style="color:var(--muted);font-size:.85rem">of ' + site.target_trees.toLocaleString() + ' target</div><div style="margin-top:.75rem"><div class="progress-bar" style="height:8px"><div class="progress-fill" style="width:' + Math.min(site.progress_pct,100) + '%"></div></div><div style="margin-top:.4rem;font-size:.82rem;color:var(--sage)">' + site.progress_pct + '% complete</div></div></div>' +
    '<div class="detail-block"><div class="detail-label">Survival Rate</div><div class="big-number" style="color:' + (site.survival_rate < 85 ? 'var(--danger)' : site.survival_rate < 90 ? 'var(--warn)' : 'var(--moss)') + '">' + site.survival_rate + '%</div><div style="color:var(--muted);font-size:.85rem">' + site.surviving.toLocaleString() + ' surviving trees</div></div></div>';

  html += '<div class="site-detail-grid" style="grid-template-columns:repeat(4,1fr)">' +
    '<div class="detail-block"><div class="detail-label">Area</div><div class="detail-value">' + site.area_ha + ' ha</div></div>' +
    '<div class="detail-block"><div class="detail-label">Officer</div><div class="detail-value">' + (site.officer_name || 'â€”') + '</div></div>' +
    '<div class="detail-block"><div class="detail-label">Start Date</div><div class="detail-value">' + site.start_date + '</div></div>' +
    '<div class="detail-block"><div class="detail-label">Target Date</div><div class="detail-value">' + (site.target_date || 'â€”') + '</div></div></div>';

  if (site.notes) html += '<div class="detail-block" style="margin-bottom:1.5rem"><div class="detail-label">Notes</div><div style="font-size:.92rem;margin-top:.3rem">' + site.notes + '</div></div>';

  if (site.photos && site.photos.length) {
    html += '<div class="detail-block" style="margin-bottom:1.5rem"><div class="detail-label">ğŸ“¸ Site Photos (' + site.photos.length + ')</div>' +
      '<div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem">' +
      site.photos.map(function(url) {
        return '<img src="' + url + '" style="width:100px;height:100px;object-fit:cover;border-radius:.5rem;border:1px solid var(--border);cursor:pointer" onclick="window.open(\'' + url + '\')">';
      }).join('') + '</div></div>';
  }

  html += '<div style="font-size:.8rem;color:var(--muted);font-family:\'Syne\',sans-serif">Last updated: ' + site.last_updated + ' Â· Coordinates: ' + site.lat + ', ' + site.lng + '</div>';

  document.getElementById('site-detail-content').innerHTML = html;
  navigate('site-detail');
}

// â”€â”€ REPORTS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReportsPage() {
  var el = document.getElementById('reports-list');
  if (!state.reports.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">No reports yet</div></div>'; return; }
  el.innerHTML = state.reports.map(function(r) {
    var photosHtml = '';
    if (r.photos && r.photos.length) {
      photosHtml = '<div style="display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.75rem">' +
        r.photos.slice(0,4).map(function(url) {
          return '<img src="' + url + '" style="width:60px;height:60px;object-fit:cover;border-radius:.35rem;border:1px solid var(--border);cursor:pointer" onclick="window.open(\'' + url + '\')">';
        }).join('') +
        (r.photos.length > 4 ? '<div style="width:60px;height:60px;background:var(--surface2);border-radius:.35rem;display:flex;align-items:center;justify-content:center;font-size:.8rem;color:var(--muted)">+' + (r.photos.length - 4) + '</div>' : '') +
        '</div>';
    }
    return '<div class="report-card"><div class="report-header"><div><div class="report-site">' + (r.site_name || r.site_id) + '</div><div style="font-size:.78rem;color:var(--muted);font-family:\'Syne\',sans-serif">by ' + (r.officer_name || r.officer_id) + '</div></div><span class="report-date">' + r.date + '</span></div>' +
      '<div class="report-stats"><div class="report-stat">ğŸŒ± Planted today: <span>' + r.trees_planted_today + '</span></div><div class="report-stat">ğŸ’€ Died: <span style="color:' + (r.trees_died > 0 ? 'var(--coral)' : 'var(--muted)') + '">' + r.trees_died + '</span></div><div class="report-stat">ğŸŒ¤ï¸ ' + (r.weather || 'â€”') + '</div><div class="report-stat">ğŸ“¸ ' + (r.photos_count || 0) + ' photos</div></div>' +
      (r.challenges && r.challenges !== 'None' ? '<div class="report-challenge">âš ï¸ ' + r.challenges + '</div>' : '') +
      photosHtml + '</div>';
  }).join('');
}

// â”€â”€ SUBMIT REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateSiteSelect() {
  var sel = document.getElementById('rpt-site');
  sel.innerHTML = state.sites.map(function(s) { return '<option value="' + s.id + '">' + s.name + ' (' + s.county + ')</option>'; }).join('');
}

function submitReport() {
  var msgEl = document.getElementById('report-msg');
  var errEl = document.getElementById('report-err');
  msgEl.style.display = errEl.style.display = 'none';

  var planted = parseInt(document.getElementById('rpt-planted').value);
  var body = {
    site_id:             document.getElementById('rpt-site').value,
    trees_planted_today: planted,
    trees_died:          parseInt(document.getElementById('rpt-died').value) || 0,
    weather:             document.getElementById('rpt-weather').value,
    soil_condition:      document.getElementById('rpt-soil').value,
    challenges:          document.getElementById('rpt-challenges').value,
    photos:              JSON.parse(document.getElementById('rpt-photos-data').value || '[]'),
  };

  if (!body.site_id || isNaN(planted)) { errEl.textContent = 'Please select a site and enter trees planted today'; errEl.style.display = 'block'; return; }

  apiCall('/reports', 'POST', body).then(function(result) {
    if (!result.res.ok) { errEl.textContent = result.data.error; errEl.style.display = 'block'; return; }
    msgEl.textContent = 'âœ… Report submitted! Site now shows ' + result.data.site.planted.toLocaleString() + ' trees planted (' + result.data.site.survival_rate + '% survival).';
    msgEl.style.display = 'block';
    Promise.all([loadSites(), loadReports(), loadAlerts(), loadStats()]).then(function() { toast('Report submitted!', 'success'); });
  }).catch(function() { errEl.textContent = 'Connection error.'; errEl.style.display = 'block'; });
}

// â”€â”€ ADD SITE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitNewSite() {
  var msgEl = document.getElementById('add-site-msg');
  var errEl = document.getElementById('add-site-err');
  msgEl.style.display = errEl.style.display = 'none';

  var speciesRaw = document.getElementById('ns-species').value;
  var species = speciesRaw ? speciesRaw.split(',').map(function(s) { return s.trim(); }).filter(Boolean) : [];

  var body = {
    name:        document.getElementById('ns-name').value.trim(),
    county:      document.getElementById('ns-county').value,
    sub_county:  document.getElementById('ns-sub').value,
    type:        document.getElementById('ns-type').value,
    target_trees:document.getElementById('ns-target').value,
    area_ha:     document.getElementById('ns-area').value,
    lat:         document.getElementById('ns-lat').value,
    lng:         document.getElementById('ns-lng').value,
    start_date:  document.getElementById('ns-start').value,
    target_date: document.getElementById('ns-end').value,
    species:     species,
    notes:       document.getElementById('ns-notes').value,
    photos:      JSON.parse(document.getElementById('site-photos-data').value || '[]'),
  };

  if (!body.name || !body.county || !body.type || !body.target_trees || !body.lat || !body.lng || !body.start_date) {
    errEl.textContent = 'Please fill in all required (*) fields'; errEl.style.display = 'block'; return;
  }

  apiCall('/sites', 'POST', body).then(function(result) {
    if (!result.res.ok) { errEl.textContent = result.data.error; errEl.style.display = 'block'; return; }
    msgEl.textContent = 'âœ… Site "' + result.data.name + '" registered with ID ' + result.data.id;
    msgEl.style.display = 'block';
    loadSites();
    toast('Site registered!', 'success');
  }).catch(function() { errEl.textContent = 'Connection error.'; errEl.style.display = 'block'; });
}

// â”€â”€ ALERTS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAlertsPage() {
  var el = document.getElementById('alerts-list-full');
  document.getElementById('alerts-page-count').textContent = state.alerts.length;
  if (!state.alerts.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">âœ…</div><div class="empty-text">No active alerts â€” all sites performing well!</div></div>';
    return;
  }
  var canResolve = ['admin','officer','ngo'].indexOf(state.user && state.user.role) > -1;
  el.innerHTML = state.alerts.map(function(a) {
    return '<div class="alert-item ' + a.severity + '"><div class="alert-dot"></div><div class="alert-msg" style="flex:1"><strong>' + (a.site_name || a.site_id) + '</strong> Â· ' + (a.county || '') + '<div style="margin-top:.3rem">' + a.message + '</div><div class="alert-meta">' + new Date(a.created_at).toLocaleDateString('en-KE',{day:'numeric',month:'short',year:'numeric'}) + '</div></div>' +
      (canResolve ? '<button class="btn btn-outline btn-sm" onclick="resolveAlert(\'' + a.id + '\')">Resolve</button>' : '') + '</div>';
  }).join('');
}

function resolveAlert(id) {
  apiCall('/alerts/' + id + '/resolve', 'PATCH').then(function(r) {
    if (r.res.ok) {
      Promise.all([loadAlerts(), loadSites(), loadStats()]).then(function() { renderAlertsPage(); renderDashboard(); toast('Alert resolved', 'success'); });
    }
  });
}

// â”€â”€ USERS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUsersPage() {
  var tbody = document.getElementById('users-tbody');
  tbody.innerHTML = state.users.map(function(u) {
    var isSelf = state.user && state.user.id === u.id;
    var isLastAdmin = u.role === 'admin' && state.users.filter(function(x){ return x.role === 'admin'; }).length <= 1;
    return '<tr><td><div style="display:flex;align-items:center;gap:.75rem"><div style="width:32px;height:32px;border-radius:50%;background:var(--moss);color:var(--bg);font-family:\'Syne\',sans-serif;font-size:.75rem;font-weight:800;display:flex;align-items:center;justify-content:center">' + (u.avatar || u.name.slice(0,2)) + '</div><span style="font-family:\'Syne\',sans-serif;font-size:.88rem;font-weight:700">' + u.name + (isSelf ? ' <span style="font-size:.7rem;color:var(--moss)">(you)</span>' : '') + '</span></div></td>' +
      '<td style="font-size:.85rem;color:var(--muted)">' + u.email + '</td>' +
      '<td><span class="badge ' + (u.role === 'admin' ? 'badge-danger' : u.role === 'officer' ? 'badge-active' : 'badge-planning') + '">' + u.role + '</span></td>' +
      '<td>' + (u.county || 'â€”') + '</td>' +
      '<td style="font-size:.82rem;color:var(--muted)">' + u.joined + '</td>' +
      '<td><div style="display:flex;gap:.4rem">' +
      '<button class="btn btn-outline btn-sm" onclick="openChangePassword(\'' + u.id + '\',\'' + u.name + '\')">ğŸ”‘</button>' +
      (!isSelf && !isLastAdmin ? '<button class="btn btn-outline btn-sm" style="border-color:var(--danger);color:var(--danger)" onclick="deleteUser(\'' + u.id + '\',\'' + u.name + '\')">ğŸ—‘</button>' : '') +
      '</div></td></tr>';
  }).join('');
}

function openAddUser()  { document.getElementById('add-user-modal').classList.add('open'); }
function closeAddUser() { document.getElementById('add-user-modal').classList.remove('open'); }

function submitAddUser() {
  var errEl = document.getElementById('add-user-err');
  errEl.style.display = 'none';
  var body = {
    name:     document.getElementById('nu-name').value.trim(),
    email:    document.getElementById('nu-email').value.trim(),
    password: document.getElementById('nu-password').value,
    role:     document.getElementById('nu-role').value,
    county:   document.getElementById('nu-county').value,
  };
  if (!body.name || !body.email || !body.password) { errEl.textContent = 'Name, email & password required'; errEl.style.display = 'block'; return; }
  apiCall('/users', 'POST', body).then(function(r) {
    if (!r.res.ok) { errEl.textContent = r.data.error; errEl.style.display = 'block'; return; }
    loadUsers().then(function() { renderUsersPage(); closeAddUser(); toast('User created!', 'success'); });
  });
}

// â”€â”€ DELETE USER (admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteUser(id, name) {
  if (!confirm('Delete user "' + name + '"? This cannot be undone.')) return;
  apiCall('/users/' + id, 'DELETE').then(function(r) {
    if (r.res.ok) {
      toast('User deleted', 'success');
      loadUsers().then(function() { renderUsersPage(); });
    } else {
      toast(r.data.error || 'Error deleting user', 'error');
    }
  });
}

// â”€â”€ CHANGE PASSWORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var changePwUserId = null;

function openChangePassword(id, name) {
  changePwUserId = id;
  var isSelf = state.user && state.user.id === id;
  document.getElementById('change-pw-name').textContent = name;
  document.getElementById('change-pw-current-wrap').style.display = isSelf ? 'flex' : 'none';
  document.getElementById('change-pw-current').value = '';
  document.getElementById('change-pw-new').value = '';
  document.getElementById('change-pw-confirm').value = '';
  document.getElementById('change-pw-err').style.display = 'none';
  document.getElementById('change-pw-success').style.display = 'none';
  document.getElementById('change-pw-modal').classList.add('open');
}

function closeChangePassword() {
  document.getElementById('change-pw-modal').classList.remove('open');
  changePwUserId = null;
}

function submitChangePassword() {
  var errEl = document.getElementById('change-pw-err');
  var sucEl = document.getElementById('change-pw-success');
  errEl.style.display = sucEl.style.display = 'none';

  var newPw     = document.getElementById('change-pw-new').value;
  var confirmPw = document.getElementById('change-pw-confirm').value;
  var currentPw = document.getElementById('change-pw-current').value;
  var isSelf    = state.user && state.user.id === changePwUserId;

  if (!newPw) { errEl.textContent = 'Please enter a new password'; errEl.style.display = 'block'; return; }
  if (newPw !== confirmPw) { errEl.textContent = 'Passwords do not match'; errEl.style.display = 'block'; return; }
  if (isSelf && !currentPw) { errEl.textContent = 'Please enter your current password'; errEl.style.display = 'block'; return; }

  var body = { new_password: newPw };
  if (isSelf) body.current_password = currentPw;

  apiCall('/users/' + changePwUserId + '/password', 'PATCH', body).then(function(r) {
    if (!r.res.ok) { errEl.textContent = r.data.error; errEl.style.display = 'block'; return; }
    sucEl.textContent = 'âœ… Password updated successfully!';
    sucEl.style.display = 'block';
    setTimeout(closeChangePassword, 1500);
    toast('Password updated!', 'success');
  });
}

// â”€â”€ DELETE OWN ACCOUNT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDeleteAccount() {
  document.getElementById('delete-account-pw').value = '';
  document.getElementById('delete-account-err').style.display = 'none';
  document.getElementById('delete-account-modal').classList.add('open');
}

function closeDeleteAccount() {
  document.getElementById('delete-account-modal').classList.remove('open');
}

function submitDeleteAccount() {
  var errEl = document.getElementById('delete-account-err');
  errEl.style.display = 'none';
  var password = document.getElementById('delete-account-pw').value;
  if (!password) { errEl.textContent = 'Please enter your password'; errEl.style.display = 'block'; return; }

  apiCall('/users/' + state.user.id + '/self', 'DELETE', { password: password }).then(function(r) {
    if (!r.res.ok) { errEl.textContent = r.data.error; errEl.style.display = 'block'; return; }
    closeDeleteAccount();
    logout();
    toast('Account deleted', 'success');
  });
}

// â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSection(id) {
  var el = document.getElementById(id);
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function statusBadge(status, alert) {
  if (alert) return '<span class="badge badge-danger">âš ï¸ Alert</span>';
  var map = { active:'badge-active', planning:'badge-planning', complete:'badge-complete' };
  return '<span class="badge ' + (map[status] || 'badge-planning') + '">' + status + '</span>';
}

function typeName(t) {
  var m = { forest_corridor:'Forest Corridor', urban_park:'Urban Park', road_corridor:'Road Corridor', wetland_mangrove:'Wetland/Mangrove', school_greening:'School Greening', community_garden:'Community Garden' };
  return m[t] || t;
}

function alertTypeName(t) {
  var m = { survival_rate_low:'Survival rate below 85%', behind_schedule:'Site is behind schedule' };
  return m[t] || t;
}

var toastTimer;
function toast(msg, type) {
  type = type || 'success';
  var el = document.getElementById('toast');
  el.textContent = (type === 'success' ? 'âœ… ' : 'âŒ ') + msg;
  el.className = 'show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { el.className = ""; }, 3500);
}
</script>
</body>
</html>
